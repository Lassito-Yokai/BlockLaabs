{% extends "base.html" %}
{% load rawdocs_extras %}
{% load static %}
{% block title %}Annotation {{ document.file.name|basename }} ‚Äì RawDocs{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<!-- ADD THIS TO THE TOP OF YOUR annotate_document.html AFTER THE BOOTSTRAP CSS LINK -->

<style>
/* NUCLEAR OPTION: Override ALL modal conflicts */
.context-menu {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    padding: 0;
    min-width: 150px;
}

.context-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
    color: #333;
    transition: background-color 0.2s;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item.danger {
    color: #dc3545;
}

.context-menu-item.danger:hover {
    background-color: #f8d7da;
}

/* Hide context menu initially */
.context-menu.hidden {
    display: none;
}
/* Force modal to appear above EVERYTHING */
.modal {
    z-index: 999999 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
    display: none !important;
}

.modal.show {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Force backdrop to be clickable and properly positioned */
.modal-backdrop {
    z-index: 999998 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
}

/* Force modal dialog to be above backdrop and clickable */
.modal-dialog {
    z-index: 1000000 !important;
    position: relative !important;
    margin: 1.75rem auto !important;
    max-width: 500px !important;
    width: 90% !important;
    pointer-events: auto !important;
}

/* Force modal content styling */
.modal-content {
    background: white !important;
    border: none !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8) !important;
    pointer-events: auto !important;
    position: relative !important;
    z-index: 1000001 !important;
}

.modal-header {
    background: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.modal-title {
    color: #495057 !important;
    font-weight: 500 !important;
    margin: 0 !important;
}

.modal-body {
    background: white !important;
    padding: 1.5rem !important;
    color: #495057 !important;
}

.modal-footer {
    background: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0 0 0.5rem 0.5rem !important;
}

/* Force all form elements to work properly */
.modal input,
.modal select,
.modal textarea {
    background: white !important;
    border: 1px solid #ced4da !important;
    color: #495057 !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 0.25rem !important;
    width: 100% !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal input:focus,
.modal select:focus,
.modal textarea:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    outline: 0 !important;
}

.modal .form-label {
    color: #495057 !important;
    font-weight: 500 !important;
    margin-bottom: 0.5rem !important;
}

.modal .btn {
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close {
    background: transparent !important;
    border: none !important;
    color: #000 !important;
    opacity: 0.5 !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close:hover {
    opacity: 1 !important;
}

/* Remove ANY other z-index that might interfere */
.annotation-header,
.annotation-types-panel,
.page-navigation,
.text-content-card,
.annotations-list,
.learning-dashboard-widget {
    z-index: auto !important;
    position: relative !important;
}

/* Ensure the page content doesn't interfere */
.app-container,
.site-header,
body {
    z-index: auto !important;
}

/* Force click events to work */
.modal * {
    pointer-events: auto !important;
}

.modal-dialog * {
    pointer-events: auto !important;
}

.modal-content * {
    pointer-events: auto !important;
}
</style>

<!-- ALSO ADD THIS JAVASCRIPT AFTER YOUR EXISTING SCRIPTS -->
<script>
// NUCLEAR JAVASCRIPT FIX
document.addEventListener('DOMContentLoaded', function() {
    
    // Force remove any conflicting event listeners
    function showAddAnnotationTypeModalFixed() {
        console.log('üöÄ Opening modal...');
        
        // Clear form
        document.getElementById('new-annotation-display-name').value = '';
        document.getElementById('new-annotation-name').value = '';
        
        // Get modal element
        const modalElement = document.getElementById('addAnnotationTypeModal');
        
        if (!modalElement) {
            console.error('Modal element not found!');
            return;
        }
        
        // Destroy any existing modal instance
        const existingModal = bootstrap.Modal.getInstance(modalElement);
        if (existingModal) {
            existingModal.dispose();
        }
        
        // Create fresh modal instance
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
        
        // Force show
        modal.show();
        
        // Ensure it's clickable after showing
        setTimeout(() => {
            const dialog = modalElement.querySelector('.modal-dialog');
            const content = modalElement.querySelector('.modal-content');
            
            if (dialog) {
                dialog.style.pointerEvents = 'auto';
                dialog.style.zIndex = '1000000';
            }
            
            if (content) {
                content.style.pointerEvents = 'auto';
                content.style.zIndex = '1000001';
            }
            
            // Force focus on first input
            const firstInput = modalElement.querySelector('input[type="text"]');
            if (firstInput) {
                firstInput.focus();
            }
        }, 100);
        
        console.log('‚úÖ Modal should be open and clickable now');
    }
    
    // Replace the existing function
    window.showAddAnnotationTypeModal = showAddAnnotationTypeModalFixed;
    
    // Also fix the create function
    window.createAnnotationTypeFixed = function() {
        console.log('üéØ Creating annotation type...');
        
        const displayName = document.getElementById('new-annotation-display-name').value.trim();
        const name = document.getElementById('new-annotation-name').value.trim();

        if (!displayName) {
            alert('Please enter a display name');
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/create-annotation-type/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                display_name: displayName,
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);

                // Add new button
                addNewAnnotationButtonToAnnotateur(data.annotation_type);

                // Force close modal
                const modalElement = document.getElementById('addAnnotationTypeModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // Clear form
                document.getElementById('new-annotation-display-name').value = '';
                document.getElementById('new-annotation-name').value = '';
                
                console.log('‚úÖ Annotation type created successfully');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating annotation type');
        });
    };
    
    // Replace the create function
    window.createAnnotationType = window.createAnnotationTypeFixed;
    
    console.log('üîß Modal fixes applied');
});
</script>

<style>
:root {
  --primary: #0f172a;       /* Bleu nuit tr√®s fonc√© */
  --primary-hover: #1e293b; /* Bleu nuit fonc√© */
  --secondary: #1e293b;     /* Bleu nuit */
  --accent: #3b82f6;        /* Bleu vif */
  --text-primary: #f8fafc;  /* Blanc tr√®s clair */
  --text-secondary: #e2e8f0;/* Gris bleut√© clair */
  --surface-color: #1e293b; /* Bleu nuit */
  --border-color: #334155;  /* Bleu nuit moyen */
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
  --border-radius: 8px;
  --transition-all: all 0.3s ease;
}

/* CRITICAL FIX: Ensure modals appear above everything */
.modal {
  z-index: 1060 !important;
}

.modal-backdrop {
  z-index: 1055 !important;
}

/* Fix modal dialog to ensure it's clickable */
.modal-dialog {
  z-index: 1061 !important;
  pointer-events: auto !important;
}

.modal-content {
  background: white !important;
  pointer-events: auto !important;
}

/* Remove any conflicting z-index from other elements */
.annotation-header, .page-navigation, .annotation-types-panel {
  z-index: auto !important;
}

/* Annotation Header */
.annotation-header {
  background: var(--surface-color);
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.header-info h2 {
  margin: 0 0 0.5rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.document-meta {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.meta-item {
  color: var(--text-secondary);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.header-actions {
  display: flex;
  align-items: center;
}

/* Bouton Retour visible */
.btn-outline {
  background: transparent;
  color: var(--accent);
  border: 1px solid var(--accent);
  padding: 0.65rem 1.25rem;
  border-radius: var(--border-radius);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: var(--transition-all);
  font-weight: 500;
  font-size: 0.9rem;
}

.btn-outline:hover {
  background: rgba(59, 130, 246, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

/* Annotation Types Panel */
.annotation-types-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-color);
}

.annotation-types-panel h3 {
  margin: 0 0 0.5rem;
  font-size: 1.25rem;
  color: white;
}

.instructions {
  margin: 0 0 1rem;
  opacity: 0.9;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.annotation-types {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.annotation-type-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  color: white;
  cursor: pointer;
  transition: var(--transition-all);
  font-weight: 500;
}

.annotation-type-btn:hover,
.annotation-type-btn.active {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.annotation-type-btn-add {
  background: linear-gradient(45deg, #10b981, #059669);
  border: 2px solid #10b981;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  cursor: pointer;
  transition: var(--transition-all);
  font-weight: 500;
}

.annotation-type-btn-add:hover {
  background: linear-gradient(45deg, #059669, #047857);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.annotation-mode {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  color: white;
}

.current-mode {
  background: rgba(255, 255, 255, 0.2);
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-weight: 600;
  color: white;
}

.help-text {
  margin: 0;
  font-size: 0.85rem;
  opacity: 0.8;
  color: var(--text-secondary);
}

/* Page Navigation */
.page-navigation {
  background: var(--surface-color);
  padding: 1rem 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.page-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.nav-btn {
  background: var(--primary);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: var(--border-radius);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: var(--transition-all);
  border: 1px solid var(--border-color);
}

.nav-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
}

.page-selector select {
  padding: 0.5rem;
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  background: var(--primary);
  color: white;
}

.ai-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Bouton AI */
.btn-groq {
  background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
}

.btn-groq:hover {
  background: var(--primary-hover);
}

/* Bouton Validate */
.btn-validate {
  background: var(--primary);
  color: white;
  border: 1px solid #10b981;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
}

.btn-validate:hover:not(:disabled) {
  background: var(--primary-hover);
}

.btn-validate:disabled {
  background: #1e293b;
  color: #64748b;
  cursor: not-allowed;
}

/* Bouton Expert */
.btn-expert {
  background: linear-gradient(45deg, #6f42c1, #495057);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
}

.btn-expert:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(111, 66, 193, 0.4);
}

.ai-loading {
  color: white;
  font-weight: 500;
}

.learning-progress {
  color: white;
}

/* Text Content */
.text-content-card {
  background: var(--surface-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.text-content-card h3 {
  margin: 0 0 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
}

.page-status {
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: auto;
}

.page-status.validated-human {
  background: #d1fae5;
  color: #047857;
}

.page-status.annotated {
  background: #d1fae5;
  color: #047857;
}

.page-status.pending {
  background: #fef3c7;
  color: #92400e;
}

.text-content {
  border: 2px dashed var(--border-color);
  padding: 1.5rem;
  border-radius: var(--border-radius);
  line-height: 1.6;
  font-size: 1rem;
  user-select: text;
  cursor: text;
  white-space: pre-wrap;
  min-height: 300px;
  background: var(--primary);
  color: white;
}

/* Annotations List */
.annotations-list {
  background: var(--surface-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.annotations-list h3 {
  margin: 0 0 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
}

.annotation-item {
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1rem;
  margin-bottom: 1rem;
  background: var(--primary);
}

.annotation-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.annotation-type {
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
}

.annotation-confidence {
  background: var(--surface-color);
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: 600;
  color: white;
}

.delete-annotation {
  background: none;
  border: none;
  color: #ef4444;
  cursor: pointer;
  padding: 0.25rem;
  margin-left: auto;
}

.annotation-text {
  font-style: italic;
  color: white;
  margin-bottom: 0.5rem;
}

.annotation-reasoning {
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

/* Learning Dashboard Widget */
.learning-dashboard-widget {
  background: var(--primary);
  color: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.learning-dashboard-widget h4 {
  color: white;
  margin-top: 0;
}

/* Validation Success Message */
.validation-success {
  background: linear-gradient(45deg, #10b981, #059669);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: opacity 0.5s ease;
}

.validation-success i {
  font-size: 1.5rem;
}

.validation-details {
  margin-top: 0.5rem;
}

.metric-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0.25rem 0;
}

.metric-row.total {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255,255,255,0.2);
}

.metric-row.score {
  font-weight: bold;
  color: #fef3c7;
}

/* BOOTSTRAP MODAL FIXES - CRITICAL */
.modal-dialog {
  margin: 1.75rem auto !important;
  max-width: 500px !important;
}

.modal-content {
  border: none !important;
  border-radius: 0.5rem !important;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
}

.modal-header {
  background-color: #f8f9fa !important;
  border-bottom: 1px solid #dee2e6 !important;
  border-radius: 0.5rem 0.5rem 0 0 !important;
}

.modal-body {
  background-color: white !important;
  padding: 1.5rem !important;
}

.modal-footer {
  background-color: #f8f9fa !important;
  border-top: 1px solid #dee2e6 !important;
  border-radius: 0 0 0.5rem 0.5rem !important;
}

/* Form controls in modal */
.modal .form-control {
  background-color: white !important;
  border: 1px solid #ced4da !important;
  color: #495057 !important;
}

.modal .form-control:focus {
  border-color: #80bdff !important;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.modal .form-label {
  color: #495057 !important;
  font-weight: 500 !important;
}

/* Responsive */
@media (max-width: 768px) {
  .annotation-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .page-navigation {
    flex-direction: column;
    gap: 1rem;
  }

  .annotation-types {
    justify-content: center;
  }

  .header-actions {
    margin-top: 1rem;
    width: 100%;
  }

  .btn-outline {
    width: 100%;
    justify-content: center;
  }
}
</style>

<!-- Annotation Header -->
<section class="annotation-header">
  <div class="header-info">
    <h2><i class="fas fa-file-pdf"></i> {{ document.file.name|basename }}</h2>
    <div class="document-meta">
      <span class="meta-item">
        <i class="fas fa-user"></i>
        {{ document.owner.username }}
      </span>
      <span class="meta-item">
        <i class="fas fa-file-alt"></i>
        Page {{ current_page.page_number }} / {{ total_pages }}
      </span>
      <span class="meta-item">
        <i class="fas fa-calendar"></i>
        {{ document.validated_at|date:"d/m/Y" }}
      </span>
    </div>
  </div>

  <div class="header-actions">
    <a href="{% url 'rawdocs:annotation_dashboard' %}" class="btn-outline">
      <i class="fas fa-arrow-left"></i> Retour
    </a>
  </div>
</section>

<!-- Annotation Types Panel -->
<section class="annotation-types-panel">
  <h3>S√©lectionnez un type d'entit√©</h3>
  <p class="instructions">Cliquez sur un type, puis surlignez le texte correspondant</p>

  <div class="annotation-types">
    {% for ann_type in annotation_types %}
    <button class="annotation-type-btn"
            data-type="{{ ann_type.name }}"
            data-color="{{ ann_type.color }}"
            style="border-color: {{ ann_type.color }}; color: {{ ann_type.color }};">
      {{ ann_type.display_name }}
    </button>
    {% endfor %}
    <button class="annotation-type-btn-add" onclick="showAddAnnotationTypeModal()" type="button">
      <i class="fas fa-plus"></i> Add Custom Type
    </button>
  </div>

  <div class="annotation-mode">
    <span class="mode-label">
      <i class="fas fa-hand-pointer"></i>
      Mode annotation activ√©:
    </span>
    <span id="current-mode" class="current-mode">Aucun type s√©lectionn√©</span>
  </div>

  <p class="help-text">Surlignez du texte pour cr√©er une annotation automatiquement</p>

  <div id="context-menu" class="context-menu hidden">
    <button class="context-menu-item danger" onclick="deleteAnnotationTypeFromMenu()">
        <i class="fas fa-trash"></i> Delete Annotation Type
    </button>
    <button class="context-menu-item" onclick="hideContextMenu()">
        <i class="fas fa-times"></i> Cancel
    </button>
</div>
</section>

<!-- Page Navigation -->
<section class="page-navigation">
  <div class="page-controls">
    {% if current_page.page_number > 1 %}
      <a href="?page={{ current_page.page_number|add:'-1' }}" class="nav-btn">
        <i class="fas fa-chevron-left"></i> Page Pr√©c√©dente
      </a>
    {% endif %}

    <div class="page-selector">
      <select id="page-select" onchange="goToPage(this.value)">
        {% for page in pages %}
        <option value="{{ page.page_number }}"
                {% if page.page_number == current_page.page_number %}selected{% endif %}>
          Page {{ page.page_number }}
          {% if page.is_validated_by_human %}üéì{% elif page.is_annotated %}‚úÖ{% endif %}
        </option>
        {% endfor %}
      </select>
    </div>

    {% if current_page.page_number < total_pages %}
      <a href="?page={{ current_page.page_number|add:'1' }}" class="nav-btn">
        Page Suivante <i class="fas fa-chevron-right"></i>
      </a>
    {% endif %}
  </div>

  <div class="ai-controls">
    <!-- Enhanced AI Button -->
    <button id="groq-annotate-btn" class="btn-groq" onclick="annotateWithGroq()">
      <i class="fas fa-rocket"></i> Annotate with AI üß†
    </button>

    <!-- Validate Page Button -->
    <button id="validate-page-btn" class="btn-validate" onclick="validatePage()"
            {% if current_page.is_validated_by_human %}disabled{% endif %}>
      <i class="fas fa-graduation-cap"></i>
      {% if current_page.is_validated_by_human %}
        Page Valid√©e üéì
      {% else %}
        Validate Page
      {% endif %}
    </button>

    <!-- Expert Review Button -->
    {% if not document.is_ready_for_expert %}
      <button id="submit-document-expert-btn" class="btn-expert" onclick="submitDocumentForExpert()">
        <i class="fas fa-user-graduate"></i>
        Soumettre Document pour Expert
      </button>
    {% else %}
      <button class="btn btn-success" disabled>
        <i class="fas fa-check-circle"></i>
        Document Soumis ‚úì
      </button>
    {% endif %}

    <div id="ai-loading" class="ai-loading" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> IA en cours...
    </div>

    <!-- Learning Progress Indicator -->
    <div id="learning-progress" class="learning-progress" style="display: none;">
      <i class="fas fa-brain"></i> IA en apprentissage...
    </div>
  </div>
</section>

<!-- Learning Dashboard Widget -->
<section class="learning-dashboard-widget" id="learning-widget" style="display: none;"></section>

<!-- Main Text Content -->
<section class="text-content-card main-content">
  <h3>
    <i class="fas fa-file-text"></i>
    Page {{ current_page.page_number }}
    {% if current_page.is_validated_by_human %}
      <span class="page-status validated-human">Valid√©e par humain</span>
    {% elif current_page.is_annotated %}
      <span class="page-status annotated">Annot√©e</span>
    {% else %}
      <span class="page-status pending">En attente</span>
    {% endif %}
  </h3>

  <div id="text-content" class="text-content" data-page-id="{{ current_page.id }}">
    {{ current_page.cleaned_text }}
  </div>
</section>

<!-- Annotations List -->
<section class="annotations-list">
  <h3><i class="fas fa-tags"></i> Annotations ({{ existing_annotations.count }})</h3>

  <div id="annotations-container">
    {% for annotation in existing_annotations %}
    <div class="annotation-item" data-annotation-id="{{ annotation.id }}">
      <div class="annotation-header">
        <span class="annotation-type" style="background: {{ annotation.annotation_type.color }}">
          {{ annotation.annotation_type.display_name }}
        </span>
        <span class="annotation-confidence">{{ annotation.confidence_score|floatformat:0 }}%</span>
        <button class="delete-annotation" onclick="deleteAnnotation({{ annotation.id }})">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="annotation-text">"{{ annotation.selected_text }}"</div>
      {% if annotation.ai_reasoning %}
      <div class="annotation-reasoning">
        <i class="fas fa-lightbulb"></i> {{ annotation.ai_reasoning }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>

<!-- FIXED Modal for adding new annotation types - Expert style -->
<div class="modal fade" id="addAnnotationTypeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Annotation Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-annotation-display-name" class="form-label">Display Name</label>
                    <input type="text" class="form-control" id="new-annotation-display-name"
                           placeholder="e.g., Product, Dosage, Method">
                </div>
                <div class="mb-3">
                    <label for="new-annotation-name" class="form-label">Technical Name (auto-generated)</label>
                    <input type="text" class="form-control" id="new-annotation-name" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAnnotationType()">
                    Create Type
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'rawdocs/js/rlhf_annotation.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// MISSING VARIABLE - This is what's causing the error!
let annotationTypeMap = {};

// Initialize the type mapping when page loads
document.addEventListener('DOMContentLoaded', function() {
    
    // BUILD THE TYPE MAPPING FIRST - This was missing!
    {% for ann_type in annotation_types %}
    annotationTypeMap['{{ ann_type.name|escapejs }}'] = {{ ann_type.id }};
    {% endfor %}
    
    console.log('üìã Annotation type mapping loaded:', annotationTypeMap);
});

// ALSO UPDATE your createAnnotationType function to add new types to the map
function createAnnotationType() {
    const displayName = document.getElementById('new-annotation-display-name').value.trim();
    const name = document.getElementById('new-annotation-name').value.trim();

    if (!displayName) {
        alert('Please enter a display name');
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/create-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            display_name: displayName,
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);

            // CRITICAL: Add the new type to our mapping!
            annotationTypeMap[data.annotation_type.name] = data.annotation_type.id;
            console.log('üìã Updated type mapping:', annotationTypeMap);

            // Add new button to the interface immediately
            addNewAnnotationButtonToAnnotateur(data.annotation_type);

            // Close modal properly
            const modalElement = document.getElementById('addAnnotationTypeModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Clear form
            document.getElementById('new-annotation-display-name').value = '';
            document.getElementById('new-annotation-name').value = '';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating annotation type');
    });
}
</script>

<script>
let selectedAnnotationType = null;
let selectedColor = null;

// FIXED: Initialize annotation type selection
document.addEventListener('DOMContentLoaded', function() {
    // Initialize annotation type buttons
    document.querySelectorAll('.annotation-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.annotation-type-btn').forEach(b => b.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Set selected type
            selectedAnnotationType = this.dataset.type;
            selectedColor = this.dataset.color;

            // Update current mode display
            document.getElementById('current-mode').textContent = this.textContent;
            document.getElementById('current-mode').style.backgroundColor = selectedColor;
        });
    });

    // Auto-generate technical name from display name
    document.getElementById('new-annotation-display-name').addEventListener('input', function() {
        const displayName = this.value;
        const technicalName = displayName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        document.getElementById('new-annotation-name').value = technicalName;
    });

    // Mark validated pages
    const validateBtn = document.getElementById('validate-page-btn');
    if (validateBtn?.textContent?.includes('Valid√©e')) {
        showLearningWidget({});
    }

    // Add indicators to AI-generated annotations
    document.querySelectorAll('.annotation-item').forEach(annotation => {
        if (annotation.querySelector('.annotation-reasoning')?.textContent?.includes('RLHF')) {
            annotation.classList.add('ai-generated');
            const indicator = document.createElement('div');
            indicator.className = 'rlhf-indicator';
            indicator.innerHTML = '<i class="fas fa-brain"></i> IA Apprenante';
            annotation.appendChild(indicator);
        }
    });
});

// Text selection for manual annotation
document.getElementById('text-content').addEventListener('mouseup', function() {
  if (!selectedAnnotationType) {
    alert('Veuillez d\'abord s√©lectionner un type d\'annotation');
    return;
  }

  const selection = window.getSelection();
  if (selection.toString().trim().length === 0) return;

  const range = selection.getRangeAt(0);
  const selectedText = selection.toString().trim();

  // Calculate positions
  const textContent = this.textContent;
  const startPos = getTextPosition(this, range.startContainer, range.startOffset);
  const endPos = startPos + selectedText.length;

  // Save annotation
  saveManualAnnotation({
    page_id: this.dataset.pageId,
    type_id: getAnnotationTypeId(selectedAnnotationType),
    start_pos: startPos,
    end_pos: endPos,
    selected_text: selectedText
  });

  // Clear selection
  selection.removeAllRanges();
});

function getTextPosition(container, node, offset) {
  let position = 0;
  const walker = document.createTreeWalker(
    container,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );

  let currentNode;
  while (currentNode = walker.nextNode()) {
    if (currentNode === node) {
      return position + offset;
    }
    position += currentNode.textContent.length;
  }
  return position;
}

function getAnnotationTypeId(typeName) {
    console.log('üîç Looking for type:', typeName);
    console.log('üìã Available types:', annotationTypeMap);
    
    const typeId = annotationTypeMap[typeName];
    if (!typeId) {
        console.error('‚ùå Type ID not found for:', typeName);
        console.error('Available types:', Object.keys(annotationTypeMap));
        return null;
    }
    
    console.log('‚úÖ Found type ID:', typeId, 'for type:', typeName);
    return typeId;
}

function saveManualAnnotation(data) {
  fetch('{% url "rawdocs:save_manual_annotation" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // Refresh to show new annotation
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Erreur lors de la sauvegarde');
  });
}

function deleteAnnotation(annotationId) {
  if (!confirm('Supprimer cette annotation ?')) return;

  fetch(`{% url "rawdocs:delete_annotation" 0 %}`.replace('0', annotationId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  });
}

function goToPage(pageNumber) {
  window.location.href = `?page=${pageNumber}`;
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function submitDocumentForExpert() {
    if (confirm('Soumettre ce document complet pour r√©vision expert ?')) {
        const documentId = {{ document.id }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/submit-for-expert/${documentId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}

// FIXED: Modal handling like expert module
function showAddAnnotationTypeModal() {
    // Clear previous values
    document.getElementById('new-annotation-display-name').value = '';
    document.getElementById('new-annotation-name').value = '';
    
    // Show modal with proper Bootstrap 5 method
    const modal = new bootstrap.Modal(document.getElementById('addAnnotationTypeModal'), {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    modal.show();
}


function addNewAnnotationButtonToAnnotateur(annotationType) {
    // Check if button already exists to avoid duplicates
    const existingButton = document.querySelector(`[data-type="${annotationType.name}"]`);
    if (existingButton && !existingButton.classList.contains('annotation-type-btn-add')) {
        console.log('Button already exists for type:', annotationType.name);
        return;
    }
    annotationTypeMap[annotationType.name] = annotationType.id;
    console.log('üìã Updated type mapping:', annotationTypeMap);
    
    // Create new button element
    const newButton = document.createElement('button');
    newButton.className = 'annotation-type-btn';
    newButton.setAttribute('data-type', annotationType.name);
    newButton.setAttribute('data-color', annotationType.color);
    newButton.style.borderColor = annotationType.color;
    newButton.style.color = annotationType.color;
    newButton.textContent = annotationType.display_name;

    // Add event listener for the new button
    newButton.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.annotation-type-btn').forEach(b => b.classList.remove('active'));

        // Add active class to clicked button
        this.classList.add('active');

        // Set selected type
        selectedAnnotationType = this.dataset.type;
        selectedColor = this.dataset.color;

        // Update current mode display
        document.getElementById('current-mode').textContent = this.textContent;
        document.getElementById('current-mode').style.backgroundColor = selectedColor;
    });

    // Add to annotation types container (before the "Add" button)
    const container = document.querySelector('.annotation-types');
    const addButton = document.querySelector('.annotation-type-btn-add');
    if (container && addButton) {
        container.insertBefore(newButton, addButton);
    }
}

// RLHF Learning functions from the existing JS
function showLearningWidget(data) {
    let widget = document.getElementById('learning-widget') || createLearningWidget();

    fetch('/learning/dashboard/')
        .then(response => response.json())
        .then(learningData => {
            const avgScore = (learningData.average_feedback_score * 100).toFixed(0);
            const {performanceLevel, performanceIcon} = getPerformanceLevel(avgScore);

            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progr√®s d'Apprentissage IA</h4>
                <div class="learning-metrics">
                    <div class="metric">
                        <span class="metric-label">Score R√©el:</span>
                        <span class="metric-value">${avgScore}%</span>
                        <span class="performance-indicator">${performanceIcon} ${performanceLevel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Validations:</span>
                        <span class="metric-value">${learningData.total_feedbacks}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Am√©lioration:</span>
                        <span class="metric-value">üìà Active</span>
                    </div>
                </div>
                <div class="learning-explanation">
                    <small><i class="fas fa-info-circle"></i> Score bas√© sur annotations correctes, erreurs et manqu√©s</small>
                </div>
            `;
            widget.style.display = 'block';
        })
        .catch(error => {
            console.error('Learning Dashboard Error:', error);
            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progr√®s d'Apprentissage</h4>
                <div class="learning-error">
                    <i class="fas fa-exclamation-triangle"></i> Donn√©es non disponibles
                </div>
            `;
        });
}

function createLearningWidget() {
    const widget = document.createElement('section');
    widget.id = 'learning-widget';
    widget.className = 'learning-dashboard-widget';
    document.querySelector('.text-content-card')?.appendChild(widget);
    return widget;
}

function getPerformanceLevel(score) {
    score = parseInt(score);
    if (score >= 90) return {performanceLevel: 'Excellent', performanceIcon: 'üèÜ'};
    if (score >= 75) return {performanceLevel: 'Bon', performanceIcon: 'üëç'};
    if (score >= 50) return {performanceLevel: 'Apprentissage', performanceIcon: 'üéì'};
    return {performanceLevel: 'N√©cessite entrainement', performanceIcon: 'üìö'};
}

let contextMenuTarget = null;

// Context menu functionality
document.addEventListener('DOMContentLoaded', function() {
    
    // Add right-click event listeners to all annotation type buttons
    function addContextMenuToButtons() {
        document.querySelectorAll('.annotation-type-btn').forEach(btn => {
            // Remove existing listeners to prevent duplicates
            btn.removeEventListener('contextmenu', handleRightClick);
            // Add new listener
            btn.addEventListener('contextmenu', handleRightClick);
        });
    }
    
    // Initial setup
    addContextMenuToButtons();
    
    // Update the addNewAnnotationButtonToAnnotateur function to include context menu
    const originalAddFunction = window.addNewAnnotationButtonToAnnotateur;
    window.addNewAnnotationButtonToAnnotateur = function(annotationType) {
        // Call original function
        originalAddFunction(annotationType);
        
        // Add context menu to new button
        setTimeout(() => {
            addContextMenuToButtons();
        }, 100);
    };
    
    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });
    
    // Prevent default context menu on annotation buttons
    document.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('annotation-type-btn')) {
            e.preventDefault();
        }
    });
});

function handleRightClick(e) {
    e.preventDefault();
    
    // Don't show context menu for the "Add Custom Type" button
    if (e.target.classList.contains('annotation-type-btn-add')) {
        return;
    }
    
    contextMenuTarget = e.target;
    
    const contextMenu = document.getElementById('context-menu');
    const rect = e.target.getBoundingClientRect();
    
    // Position the context menu
    contextMenu.style.left = (e.pageX) + 'px';
    contextMenu.style.top = (e.pageY) + 'px';
    
    // Show the menu
    contextMenu.classList.remove('hidden');
    
    console.log('üñ±Ô∏è Right-clicked on:', e.target.textContent);
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.add('hidden');
    contextMenuTarget = null;
}

function deleteAnnotationTypeFromMenu() {
    if (!contextMenuTarget) {
        hideContextMenu();
        return;
    }
    
    const typeName = contextMenuTarget.dataset.type;
    const displayName = contextMenuTarget.textContent;
    
    // Confirm deletion
    if (!confirm(`Are you sure you want to delete the annotation type "${displayName}"?\n\nThis action cannot be undone.`)) {
        hideContextMenu();
        return;
    }
    
    console.log('üóëÔ∏è Deleting annotation type:', typeName);
    
    // Get the annotation type ID
    const typeId = annotationTypeMap[typeName];
    if (!typeId) {
        alert('Error: Could not find annotation type to delete');
        hideContextMenu();
        return;
    }
    
    // Call backend to delete the annotation type
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/delete-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            type_id: typeId,
            type_name: typeName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            
            // Remove from mapping
            delete annotationTypeMap[typeName];
            console.log('üìã Updated type mapping after deletion:', annotationTypeMap);
            
            // Remove the button from interface
            contextMenuTarget.remove();
            
            // Clear selection if this type was selected
            if (selectedAnnotationType === typeName) {
                selectedAnnotationType = null;
                selectedColor = null;
                document.getElementById('current-mode').textContent = 'Aucun type s√©lectionn√©';
                document.getElementById('current-mode').style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            }
            
            console.log('‚úÖ Annotation type deleted successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting annotation type: ' + error.message);
    })
    .finally(() => {
        hideContextMenu();
    });
}
</script>
{% endblock %}